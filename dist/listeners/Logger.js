"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const lib_1 = require("../lib");
const voice_log_1 = __importDefault(require("../models/voice-log"));
const voices = process.env.VOICES
    .split(",")
    .map(elem => elem.trim())
    .filter(elem => !!elem);
class VoiceStateListener extends lib_1.Listener {
    constructor() {
        super(...arguments);
        this.type = "voiceStateUpdate";
        this.id = "voiceStateUpdate";
    }
    async exec(oldState, newState) {
        if (!this.client.logEnabled)
            return;
        if (voices.length && !voices.includes(newState.channelID || oldState.channelID))
            return;
        if (newState.channel &&
            !oldState.channel) {
            const channel = await lib_1.Utils.AddChannel(newState.channel, this.client.logEnabledAt);
            channel.users.push({
                joinedAt: new Date(),
                leavedAt: "",
                id: newState.member.id
            });
            await voice_log_1.default.updateOne({
                channelID: newState.channelID,
                logDisabledAt: null
            }, {
                $set: {
                    users: channel.users
                }
            });
        }
        if (!newState.channel &&
            oldState.channel) {
            const channel = await lib_1.Utils.AddChannel(oldState.channel, this.client.logEnabledAt);
            const users = lib_1.Utils.UserLeaved(oldState.member, channel);
            await voice_log_1.default.updateOne({ channelID: oldState.channelID, logDisabledAt: null }, { $set: { users: users } });
        }
        if (newState.channel &&
            oldState.channel &&
            newState.channel.id != oldState.channel.id) {
            if (!voices.length || voices.includes(newState.channelID)) {
                let channel = await voice_log_1.default.findOne({ channelID: newState.channelID, logDisabledAt: null }).exec();
                channel.users.push({
                    logEnabledAt: this.client.logEnabledAt,
                    logDisabledAt: "",
                    joinedAt: new Date(),
                    leavedAt: "",
                    id: newState.member.id
                });
                await voice_log_1.default.updateOne({
                    channelID: newState.channelID
                }, {
                    $set: {
                        users: channel.users
                    }
                });
            }
            if (!voices.length || voices.includes(oldState.channelID)) {
                const channel = await lib_1.Utils.AddChannel(oldState.channel, this.client.logEnabledAt);
                const users = lib_1.Utils.UserLeaved(oldState.member, channel);
                await voice_log_1.default.updateOne({ channelID: oldState.channelID }, { $set: { users: users } });
            }
        }
    }
}
exports.default = VoiceStateListener;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTG9nZ2VyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2xpc3RlbmVycy9Mb2dnZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFDQSxnQ0FBd0M7QUFDeEMsb0VBQTBDO0FBRTFDLE1BQU0sTUFBTSxHQUFhLE9BQU8sQ0FBQyxHQUFHLENBQUMsTUFBTTtLQUN0QyxLQUFLLENBQUMsR0FBRyxDQUFDO0tBQ1YsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO0tBQ3hCLE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQTtBQUUzQixNQUFxQixrQkFBbUIsU0FBUSxjQUFRO0lBQXhEOztRQUNXLFNBQUksR0FBZSxrQkFBa0IsQ0FBQTtRQUNyQyxPQUFFLEdBQVcsa0JBQWtCLENBQUE7SUFxRTFDLENBQUM7SUFuRUcsS0FBSyxDQUFDLElBQUksQ0FBQyxRQUFvQixFQUFFLFFBQW9CO1FBQ2pELElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLFVBQVU7WUFBRSxPQUFNO1FBRW5DLElBQUksTUFBTSxDQUFDLE1BQU0sSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLFNBQVMsSUFBSSxRQUFRLENBQUMsU0FBUyxDQUFDO1lBQUUsT0FBTTtRQUd2RixJQUFJLFFBQVEsQ0FBQyxPQUFPO1lBQ2hCLENBQUMsUUFBUSxDQUFDLE9BQU8sRUFBRTtZQUNuQixNQUFNLE9BQU8sR0FBRyxNQUFNLFdBQUssQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLFlBQVksQ0FBQyxDQUFBO1lBRWxGLE9BQU8sQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDO2dCQUNmLFFBQVEsRUFBRSxJQUFJLElBQUksRUFBRTtnQkFDcEIsUUFBUSxFQUFFLEVBQUU7Z0JBQ1osRUFBRSxFQUFFLFFBQVEsQ0FBQyxNQUFNLENBQUMsRUFBRTthQUN6QixDQUFDLENBQUE7WUFDRixNQUFNLG1CQUFRLENBQUMsU0FBUyxDQUNwQjtnQkFDSSxTQUFTLEVBQUUsUUFBUSxDQUFDLFNBQVM7Z0JBQzdCLGFBQWEsRUFBRSxJQUFJO2FBQ3RCLEVBQ0Q7Z0JBQ0ksSUFBSSxFQUFFO29CQUNGLEtBQUssRUFBRSxPQUFPLENBQUMsS0FBSztpQkFDdkI7YUFDSixDQUFDLENBQUE7U0FDVDtRQUNELElBQUksQ0FBQyxRQUFRLENBQUMsT0FBTztZQUNqQixRQUFRLENBQUMsT0FBTyxFQUFFO1lBRWxCLE1BQU0sT0FBTyxHQUFHLE1BQU0sV0FBSyxDQUFDLFVBQVUsQ0FBQyxRQUFRLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsWUFBWSxDQUFDLENBQUE7WUFHbEYsTUFBTSxLQUFLLEdBQUcsV0FBSyxDQUFDLFVBQVUsQ0FBQyxRQUFRLENBQUMsTUFBTSxFQUFFLE9BQU8sQ0FBQyxDQUFBO1lBRXhELE1BQU0sbUJBQVEsQ0FBQyxTQUFTLENBQUMsRUFBQyxTQUFTLEVBQUUsUUFBUSxDQUFDLFNBQVMsRUFBRSxhQUFhLEVBQUUsSUFBSSxFQUFDLEVBQUUsRUFBQyxJQUFJLEVBQUUsRUFBQyxLQUFLLEVBQUUsS0FBSyxFQUFDLEVBQUMsQ0FBQyxDQUFBO1NBQ3pHO1FBQ0QsSUFBSSxRQUFRLENBQUMsT0FBTztZQUNoQixRQUFRLENBQUMsT0FBTztZQUNoQixRQUFRLENBQUMsT0FBTyxDQUFDLEVBQUUsSUFBSSxRQUFRLENBQUMsT0FBTyxDQUFDLEVBQUUsRUFBRTtZQUU1QyxJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sSUFBSSxNQUFNLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUMsRUFBRTtnQkFDdkQsSUFBSSxPQUFPLEdBQUcsTUFBTSxtQkFBUSxDQUFDLE9BQU8sQ0FBQyxFQUFDLFNBQVMsRUFBRSxRQUFRLENBQUMsU0FBUyxFQUFFLGFBQWEsRUFBRSxJQUFJLEVBQUMsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFBO2dCQUVqRyxPQUFPLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQztvQkFDZixZQUFZLEVBQUUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxZQUFZO29CQUN0QyxhQUFhLEVBQUUsRUFBRTtvQkFDakIsUUFBUSxFQUFFLElBQUksSUFBSSxFQUFFO29CQUNwQixRQUFRLEVBQUUsRUFBRTtvQkFDWixFQUFFLEVBQUUsUUFBUSxDQUFDLE1BQU0sQ0FBQyxFQUFFO2lCQUN6QixDQUFDLENBQUE7Z0JBQ0YsTUFBTSxtQkFBUSxDQUFDLFNBQVMsQ0FDcEI7b0JBQ0ksU0FBUyxFQUFFLFFBQVEsQ0FBQyxTQUFTO2lCQUNoQyxFQUNEO29CQUNJLElBQUksRUFBRTt3QkFDRixLQUFLLEVBQUUsT0FBTyxDQUFDLEtBQUs7cUJBQ3ZCO2lCQUNKLENBQUMsQ0FBQTthQUNUO1lBQ0QsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLElBQUksTUFBTSxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLEVBQUU7Z0JBQ3ZELE1BQU0sT0FBTyxHQUFHLE1BQU0sV0FBSyxDQUFDLFVBQVUsQ0FBQyxRQUFRLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsWUFBWSxDQUFDLENBQUE7Z0JBQ2xGLE1BQU0sS0FBSyxHQUFHLFdBQUssQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDLE1BQU0sRUFBRSxPQUFPLENBQUMsQ0FBQTtnQkFDeEQsTUFBTSxtQkFBUSxDQUFDLFNBQVMsQ0FBQyxFQUFDLFNBQVMsRUFBRSxRQUFRLENBQUMsU0FBUyxFQUFDLEVBQUUsRUFBQyxJQUFJLEVBQUUsRUFBQyxLQUFLLEVBQUUsS0FBSyxFQUFDLEVBQUMsQ0FBQyxDQUFBO2FBQ3BGO1NBQ0o7SUFDTCxDQUFDO0NBQ0o7QUF2RUQscUNBdUVDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgVm9pY2VTdGF0ZSB9IGZyb20gXCJkaXNjb3JkLmpzXCJcbmltcG9ydCB7IExpc3RlbmVyLCBVdGlscyB9IGZyb20gXCIuLi9saWJcIlxuaW1wb3J0IFZvaWNlTG9nIGZyb20gXCIuLi9tb2RlbHMvdm9pY2UtbG9nXCJcblxuY29uc3Qgdm9pY2VzOiBzdHJpbmdbXSA9IHByb2Nlc3MuZW52LlZPSUNFU1xuICAgIC5zcGxpdChcIixcIilcbiAgICAubWFwKGVsZW0gPT4gZWxlbS50cmltKCkpXG4gICAgLmZpbHRlcihlbGVtID0+ICEhZWxlbSlcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgVm9pY2VTdGF0ZUxpc3RlbmVyIGV4dGVuZHMgTGlzdGVuZXIge1xuICAgIHB1YmxpYyB0eXBlOiBFdmVudFR5cGVzID0gXCJ2b2ljZVN0YXRlVXBkYXRlXCJcbiAgICBwdWJsaWMgaWQ6IHN0cmluZyA9IFwidm9pY2VTdGF0ZVVwZGF0ZVwiXG5cbiAgICBhc3luYyBleGVjKG9sZFN0YXRlOiBWb2ljZVN0YXRlLCBuZXdTdGF0ZTogVm9pY2VTdGF0ZSkge1xuICAgICAgICBpZiAoIXRoaXMuY2xpZW50LmxvZ0VuYWJsZWQpIHJldHVyblxuXG4gICAgICAgIGlmICh2b2ljZXMubGVuZ3RoICYmICF2b2ljZXMuaW5jbHVkZXMobmV3U3RhdGUuY2hhbm5lbElEIHx8IG9sZFN0YXRlLmNoYW5uZWxJRCkpIHJldHVyblxuXG4gICAgICAgIC8vINCQINGC0YPRgiDRg9C20LUg0YDQsNC30L3Ri9C1INGD0YHQu9C+0LLQuNGPINC00LvRjyDRgNCw0LfQvdGL0YUg0LTQtdC50YHRgtCy0LjQuSDQsiDQstC+0LnRgdCw0YVcbiAgICAgICAgaWYgKG5ld1N0YXRlLmNoYW5uZWwgJiZcbiAgICAgICAgICAgICFvbGRTdGF0ZS5jaGFubmVsKSB7IC8vINCf0L7QtNC60LvRjtGH0LjQu9GB0Y8g0Log0LrQsNC90LDQu9GDXG4gICAgICAgICAgICBjb25zdCBjaGFubmVsID0gYXdhaXQgVXRpbHMuQWRkQ2hhbm5lbChuZXdTdGF0ZS5jaGFubmVsLCB0aGlzLmNsaWVudC5sb2dFbmFibGVkQXQpXG5cbiAgICAgICAgICAgIGNoYW5uZWwudXNlcnMucHVzaCh7XG4gICAgICAgICAgICAgICAgam9pbmVkQXQ6IG5ldyBEYXRlKCksXG4gICAgICAgICAgICAgICAgbGVhdmVkQXQ6IFwiXCIsXG4gICAgICAgICAgICAgICAgaWQ6IG5ld1N0YXRlLm1lbWJlci5pZFxuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIGF3YWl0IFZvaWNlTG9nLnVwZGF0ZU9uZShcbiAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgIGNoYW5uZWxJRDogbmV3U3RhdGUuY2hhbm5lbElELFxuICAgICAgICAgICAgICAgICAgICBsb2dEaXNhYmxlZEF0OiBudWxsXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICRzZXQ6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHVzZXJzOiBjaGFubmVsLnVzZXJzXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICB9XG4gICAgICAgIGlmICghbmV3U3RhdGUuY2hhbm5lbCAmJlxuICAgICAgICAgICAgb2xkU3RhdGUuY2hhbm5lbCkgeyAvLyDQktGL0YjQtdC7INC40Lcg0LrQsNC90LDQu9CwXG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGNvbnN0IGNoYW5uZWwgPSBhd2FpdCBVdGlscy5BZGRDaGFubmVsKG9sZFN0YXRlLmNoYW5uZWwsIHRoaXMuY2xpZW50LmxvZ0VuYWJsZWRBdClcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgLy8gVXNlckxlYXZlZCDQstC+0LfQstGA0LDRidCw0LXRgiDQvdC1INC+0LTQvdC+0LPQviDRjtC30LXRgNCwLCDQsCDRgdGA0LDQt9GDINC80LDRgdGB0LjQsiDRgdC+INCy0YHQtdC80Lgg0L7RgdGC0LDQu9GM0L3Ri9C80Lgg0Y7Qt9C10YDQsNC80Lgg0LrQvtGC0L7RgNGL0LUg0LHRi9C70Lgg0LfQsNGE0LjQutGB0LjRgNC+0LLQsNC90Ysg0LvQvtCz0LXRgNC+0LwsINC90L4g0LjQt9C80LXQvdGP0LXRgtGB0Y8g0LvQuNGI0Ywg0YLQvtC70YzQutC+INGD0LrQsNC30LDQvdC90YvQuVxuICAgICAgICAgICAgY29uc3QgdXNlcnMgPSBVdGlscy5Vc2VyTGVhdmVkKG9sZFN0YXRlLm1lbWJlciwgY2hhbm5lbClcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgYXdhaXQgVm9pY2VMb2cudXBkYXRlT25lKHtjaGFubmVsSUQ6IG9sZFN0YXRlLmNoYW5uZWxJRCwgbG9nRGlzYWJsZWRBdDogbnVsbH0sIHskc2V0OiB7dXNlcnM6IHVzZXJzfX0pXG4gICAgICAgIH1cbiAgICAgICAgaWYgKG5ld1N0YXRlLmNoYW5uZWwgJiZcbiAgICAgICAgICAgIG9sZFN0YXRlLmNoYW5uZWwgJiZcbiAgICAgICAgICAgIG5ld1N0YXRlLmNoYW5uZWwuaWQgIT0gb2xkU3RhdGUuY2hhbm5lbC5pZCkgeyAvLyDQn9GA0LjRiNGR0Lsg0LjQtyDQtNGA0YPQs9C+0LPQviDQutCw0L3QsNC70LBcbiAgICAgICAgICAgIC8vINCS0YLQvtGA0L7QuSDRgNCw0Lcg0L7QtNC90LAg0Lgg0YLQsCDQttC1INC/0YDQvtCy0LXRgNC60LAsINC90L4g0YLQtdC/0LXRgNGMINC+0LHQsCDQutCw0L3QsNC70LAg0YDQsNC30LTQtdC70YzQvdC+LCDRh9GC0L7QsdGLINC+0L/Rj9GC0Ywg0LbQtSDQuNC30LHQtdC20LDRgtGMINC90LXQutC+0YLQvtGA0YvRhSDQv9GA0L7QsdC70LXQvCDRgSDQkdCUXG4gICAgICAgICAgICBpZiAoIXZvaWNlcy5sZW5ndGggfHwgdm9pY2VzLmluY2x1ZGVzKG5ld1N0YXRlLmNoYW5uZWxJRCkpIHsgLy8g0JXRgdC70Lgg0LrQsNC90LDQuyDQsiDQutC+0YLQvtGA0YvQuSDQv9GA0LjRiNGR0Lsg0LvQvtCz0LjRgNGD0LXRgtGB0Y9cbiAgICAgICAgICAgICAgICBsZXQgY2hhbm5lbCA9IGF3YWl0IFZvaWNlTG9nLmZpbmRPbmUoe2NoYW5uZWxJRDogbmV3U3RhdGUuY2hhbm5lbElELCBsb2dEaXNhYmxlZEF0OiBudWxsfSkuZXhlYygpXG5cbiAgICAgICAgICAgICAgICBjaGFubmVsLnVzZXJzLnB1c2goe1xuICAgICAgICAgICAgICAgICAgICBsb2dFbmFibGVkQXQ6IHRoaXMuY2xpZW50LmxvZ0VuYWJsZWRBdCxcbiAgICAgICAgICAgICAgICAgICAgbG9nRGlzYWJsZWRBdDogXCJcIixcbiAgICAgICAgICAgICAgICAgICAgam9pbmVkQXQ6IG5ldyBEYXRlKCksXG4gICAgICAgICAgICAgICAgICAgIGxlYXZlZEF0OiBcIlwiLFxuICAgICAgICAgICAgICAgICAgICBpZDogbmV3U3RhdGUubWVtYmVyLmlkXG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICBhd2FpdCBWb2ljZUxvZy51cGRhdGVPbmUoXG4gICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNoYW5uZWxJRDogbmV3U3RhdGUuY2hhbm5lbElEXG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICRzZXQ6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB1c2VyczogY2hhbm5lbC51c2Vyc1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKCF2b2ljZXMubGVuZ3RoIHx8IHZvaWNlcy5pbmNsdWRlcyhvbGRTdGF0ZS5jaGFubmVsSUQpKSB7IC8vINCV0YHQu9C4INC60LDQvdCw0Lsg0LjQtyDQutC+0YLQvtGA0L7Qs9C+INC/0YDQuNGI0LvQuCDQu9C+0LPQuNGA0YPQtdGC0YHRj1xuICAgICAgICAgICAgICAgIGNvbnN0IGNoYW5uZWwgPSBhd2FpdCBVdGlscy5BZGRDaGFubmVsKG9sZFN0YXRlLmNoYW5uZWwsIHRoaXMuY2xpZW50LmxvZ0VuYWJsZWRBdClcbiAgICAgICAgICAgICAgICBjb25zdCB1c2VycyA9IFV0aWxzLlVzZXJMZWF2ZWQob2xkU3RhdGUubWVtYmVyLCBjaGFubmVsKVxuICAgICAgICAgICAgICAgIGF3YWl0IFZvaWNlTG9nLnVwZGF0ZU9uZSh7Y2hhbm5lbElEOiBvbGRTdGF0ZS5jaGFubmVsSUR9LCB7JHNldDoge3VzZXJzOiB1c2Vyc319KVxuICAgICAgICAgICAgfVxuICAgICAgICB9IFxuICAgIH1cbn0iXX0=