"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const discord_js_1 = require("discord.js");
const lib_1 = require("../lib");
const strftime_1 = __importDefault(require("strftime"));
const utils_1 = require("../lib/utils");
const user_1 = __importDefault(require("../models/user"));
const modes = process.env.LOGGER_MODES
    .split(',')
    .map(e => e.trim())
    .filter(e => !!e);
class StatsCommand extends lib_1.Command {
    constructor() {
        super(...arguments);
        this.aliases = ["stats", "stat", "статы", "стат", "статистика"];
        this.help = {
            name: "stats",
            description: "Статистика входов/выходов в войсах.",
            usage: "stats <Дата/Участник> [Режим]",
            category: "Логирование"
        };
        this.loggerAccessOnly = true;
    }
    async exec(message, [selectedDateOrUser, ...selectedModeArr], selectedPage = 1, prevMsg = null) {
        const selectedMode = selectedModeArr.join(' ');
        if (!selectedDateOrUser)
            return message.channel.send("❌ Хей! Подскажи пожалуйста, у кого я должен вывести статистику?");
        if (utils_1.isDate(selectedDateOrUser)) {
            const date = utils_1.GetDate(selectedDateOrUser), users = await utils_1.GetUsersForDateAndMode(date, selectedMode), page = selectedPage, maxPages = users.length, fields = [], embed = new discord_js_1.MessageEmbed({
                title: `Статистика посещения ${strftime_1.default("%d.%m.%y", date)}`,
                color: 0x2f3136,
                footer: {
                    text: `Page ${page}/${maxPages}`
                }
            });
            if (page > maxPages && page > 1)
                return await message.channel.send("❌ WTF??? Нет у меня такой страницы!");
            for (const user of users) {
                const totalTime = utils_1.GetTotalTime(user.joins), member = message.guild.members.resolve(user.userID), hours = Math.floor(totalTime / 3600 % 24), minutes = Math.floor(totalTime / 60 % 60);
                fields.push({
                    name: `${member.user.tag}  ⌚ ${hours < 10 ? "0" : ""}${hours}:${minutes < 10 ? "0" : ""}${Math.floor(minutes)}`,
                    value: user.joins.map((join, index) => `Join **#${index + 1}** ${strftime_1.default("%R", join.joinedAt)}${join.leavedAt ? `\nLeft **#${index + 1}** ${strftime_1.default("%R", join.leavedAt)}` : ""}`)
                });
            }
            embed.addFields(fields.slice((page - 1), page));
            if (!fields.length) {
                embed.setDescription("За эту сессию пользователей не зафиксировано");
                return message.channel.send(embed);
            }
            const msg = prevMsg || await message.channel.send(embed);
            if (prevMsg)
                await prevMsg.edit(embed);
            if (maxPages == 1)
                return;
            if (page > 1)
                await msg.react("◀️");
            if (page < maxPages)
                await msg.react("▶️");
            const reaction = (await msg.awaitReactions((reaction, user) => ((page > 1 && reaction.emoji.name == "◀️") || (page < maxPages && reaction.emoji.name == "▶️")) && user.id == message.author.id, { idle: 3e4, max: 1 })).first();
            if (!reaction) {
                await msg.edit(embed.setDescription(":x: Прошло 30 секунд, но никакой реакции не было найдено.\nP. s. Отправь команду ещё раз чтобы возобновить скролл."));
                await msg.reactions.removeAll();
                return;
            }
            await msg.reactions.removeAll();
            await this.exec(message, [selectedDateOrUser, selectedMode], reaction.emoji.name == "◀️" ? (page - 1) : reaction.emoji.name == "▶️" ? (page + 1) : page, msg);
            return;
        }
        const userIDs = selectedDateOrUser.match(/[0-9]{18}/g), userID = userIDs instanceof Array ? userIDs[0] : null;
        if (!userID)
            return await message.channel.send("Некорректный пользователь или дата.\nP. S. Чтобы указать пользователя используйте упоминание или ID.");
        if (!modes.includes(selectedMode))
            return await message.channel.send(`Режима \`${selectedMode || "Не указан"}\` не существует в текущем конфиге.\n` +
                `Доступные режимы: \`${modes.join('`, `')}\``);
        const userDoc = await user_1.default.findOne({ userID: userID, logMode: selectedMode }).exec(), member = message.guild.members.resolve(userID);
        const embed = new discord_js_1.MessageEmbed()
            .setColor(0x2f3136)
            .setTitle(`Статистика пользователя ${member.user.tag}`)
            .setThumbnail(member.user.displayAvatarURL())
            .setDescription(userDoc ? userDoc.note : `Данный пользователь отсутствует в базе данных в режиме \`${selectedMode}\`.`);
        if (userDoc)
            embed.addFields(Array.from(utils_1.GetSortedUserJoins(userDoc)).map(([date, joins]) => {
                const totalTime = utils_1.GetTotalTime(joins), hours = Math.floor(totalTime / 3600 % 24), minutes = Math.floor(totalTime / 60 % 60);
                return {
                    name: `${strftime_1.default("%d.%m.%y", new Date(date))}  ⌚ ${hours < 10 ? "0" : ""}${hours}:${minutes < 10 ? "0" : ""}${Math.floor(minutes)}`,
                    value: joins.map((join, index) => `**#${index + 1}** ${strftime_1.default("%R", join.joinedAt)}${join.leavedAt ? ` - ${strftime_1.default("%R", join.leavedAt)}` : ""}`)
                };
            }));
        await message.channel.send(embed);
    }
}
exports.default = StatsCommand;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU3RhdHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvY29tbWFuZHMvU3RhdHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSwyQ0FBa0Q7QUFDbEQsZ0NBQWdDO0FBRWhDLHdEQUErQjtBQUMvQix3Q0FBd0c7QUFDeEcsMERBQWlDO0FBRWpDLE1BQU0sS0FBSyxHQUFhLE9BQU8sQ0FBQyxHQUFHLENBQUMsWUFBWTtLQUMzQyxLQUFLLENBQUMsR0FBRyxDQUFDO0tBQ1YsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDO0tBQ2xCLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQTtBQUVyQixNQUFxQixZQUFhLFNBQVEsYUFBTztJQUFqRDs7UUFDVyxZQUFPLEdBQWEsQ0FBQyxPQUFPLEVBQUUsTUFBTSxFQUFFLE9BQU8sRUFBRSxNQUFNLEVBQUUsWUFBWSxDQUFDLENBQUE7UUFDcEUsU0FBSSxHQUFVO1lBQ2pCLElBQUksRUFBRSxPQUFPO1lBQ2IsV0FBVyxFQUFFLHFDQUFxQztZQUNsRCxLQUFLLEVBQUUsK0JBQStCO1lBQ3RDLFFBQVEsRUFBRSxhQUFhO1NBQzFCLENBQUE7UUFDTSxxQkFBZ0IsR0FBWSxJQUFJLENBQUE7SUE0RzNDLENBQUM7SUExR0csS0FBSyxDQUFDLElBQUksQ0FBQyxPQUFnQixFQUFFLENBQUMsa0JBQWtCLEVBQUUsR0FBRyxlQUFlLENBQVcsRUFBRSxlQUF1QixDQUFDLEVBQUUsVUFBbUIsSUFBSTtRQUM5SCxNQUFNLFlBQVksR0FBRyxlQUFlLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFBO1FBRTlDLElBQUksQ0FBQyxrQkFBa0I7WUFDbkIsT0FBTyxPQUFPLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxpRUFBaUUsQ0FBQyxDQUFBO1FBRWxHLElBQUksY0FBTSxDQUFDLGtCQUFr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QU8sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUE7SUFDckMsQ0FBQztDQUNKO0FBcEhELCtCQW9IQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE1lc3NhZ2UsIE1lc3NhZ2VFbWJlZCB9IGZyb20gJ2Rpc2NvcmQuanMnXG5pbXBvcnQgeyBDb21tYW5kIH0gZnJvbSAnLi4vbGliJ1xuaW1wb3J0IHsgSUhlbHAgfSBmcm9tICcuLi9saWIvY29tbWFuZCdcbmltcG9ydCBzdHJmdGltZSBmcm9tICdzdHJmdGltZSdcbmltcG9ydCB7IEdldERhdGUsIEdldFRvdGFsVGltZSwgR2V0VXNlcnNGb3JEYXRlQW5kTW9kZSwgaXNEYXRlLCBHZXRTb3J0ZWRVc2VySm9pbnMgfSBmcm9tICcuLi9saWIvdXRpbHMnXG5pbXBvcnQgVXNlciBmcm9tICcuLi9tb2RlbHMvdXNlcidcblxuY29uc3QgbW9kZXM6IHN0cmluZ1tdID0gcHJvY2Vzcy5lbnYuTE9HR0VSX01PREVTXG4gICAgLnNwbGl0KCcsJylcbiAgICAubWFwKGUgPT4gZS50cmltKCkpXG4gICAgLmZpbHRlcihlID0+ICEhZSlcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgU3RhdHNDb21tYW5kIGV4dGVuZHMgQ29tbWFuZCB7XG4gICAgcHVibGljIGFsaWFzZXM6IHN0cmluZ1tdID0gW1wic3RhdHNcIiwgXCJzdGF0XCIsIFwi0YHRgtCw0YLRi1wiLCBcItGB0YLQsNGCXCIsIFwi0YHRgtCw0YLQuNGB0YLQuNC60LBcIl1cbiAgICBwdWJsaWMgaGVscDogSUhlbHAgPSB7XG4gICAgICAgIG5hbWU6IFwic3RhdHNcIixcbiAgICAgICAgZGVzY3JpcHRpb246IFwi0KHRgtCw0YLQuNGB0YLQuNC60LAg0LLRhdC+0LTQvtCyL9Cy0YvRhdC+0LTQvtCyINCyINCy0L7QudGB0LDRhS5cIixcbiAgICAgICAgdXNhZ2U6IFwic3RhdHMgPNCU0LDRgtCwL9Cj0YfQsNGB0YLQvdC40Lo+IFvQoNC10LbQuNC8XVwiLFxuICAgICAgICBjYXRlZ29yeTogXCLQm9C+0LPQuNGA0L7QstCw0L3QuNC1XCJcbiAgICB9XG4gICAgcHVibGljIGxvZ2dlckFjY2Vzc09ubHk6IGJvb2xlYW4gPSB0cnVlXG5cbiAgICBhc3luYyBleGVjKG1lc3NhZ2U6IE1lc3NhZ2UsIFtzZWxlY3RlZERhdGVPclVzZXIsIC4uLnNlbGVjdGVkTW9kZUFycl06IHN0cmluZ1tdLCBzZWxlY3RlZFBhZ2U6IG51bWJlciA9IDEsIHByZXZNc2c6IE1lc3NhZ2UgPSBudWxsKSB7XG4gICAgICAgIGNvbnN0IHNlbGVjdGVkTW9kZSA9IHNlbGVjdGVkTW9kZUFyci5qb2luKCcgJylcblxuICAgICAgICBpZiAoIXNlbGVjdGVkRGF0ZU9yVXNlcilcbiAgICAgICAgICAgIHJldHVybiBtZXNzYWdlLmNoYW5uZWwuc2VuZChcIuKdjCDQpdC10LkhINCf0L7QtNGB0LrQsNC20Lgg0L/QvtC20LDQu9GD0LnRgdGC0LAsINGDINC60L7Qs9C+INGPINC00L7Qu9C20LXQvSDQstGL0LLQtdGB0YLQuCDRgdGC0LDRgtC40YHRgtC40LrRgz9cIilcblxuICAgICAgICBpZiAoaXNEYXRlKHNlbGVjdGVkRGF0ZU9yVXNlcikpIHtcbiAgICAgICAgICAgIGNvbnN0IGRhdGUgPSBHZXREYXRlKHNlbGVjdGVkRGF0ZU9yVXNlciksXG4gICAgICAgICAgICAgICAgICB1c2VycyA9IGF3YWl0IEdldFVzZXJzRm9yRGF0ZUFuZE1vZGUoZGF0ZSwgc2VsZWN0ZWRNb2RlKSxcbiAgICAgICAgICAgICAgICAgIHBhZ2UgPSBzZWxlY3RlZFBhZ2UsXG4gICAgICAgICAgICAgICAgLy8gICBtYXhQYWdlcyA9IHVzZXJzLmxlbmd0aCA8PSAxMCA/ICh1c2Vycy5sZW5ndGggLSB1c2Vycy5sZW5ndGggJSAxMCkgLyAxMCArIDEgOiAodXNlcnMubGVuZ3RoIC0gdXNlcnMubGVuZ3RoICUgMTApIC8gMTAsXG4gICAgICAgICAgICAgICAgICBtYXhQYWdlcyA9IHVzZXJzLmxlbmd0aCxcbiAgICAgICAgICAgICAgICAgIGZpZWxkcyA9IFtdLFxuICAgICAgICAgICAgICAgICAgZW1iZWQgPSBuZXcgTWVzc2FnZUVtYmVkKHtcbiAgICAgICAgICAgICAgICAgICAgICB0aXRsZTogYNCh0YLQsNGC0LjRgdGC0LjQutCwINC/0L7RgdC10YnQtdC90LjRjyAke3N0cmZ0aW1lKFwiJWQuJW0uJXlcIiwgZGF0ZSl9YCxcbiAgICAgICAgICAgICAgICAgICAgICBjb2xvcjogMHgyZjMxMzYsXG4gICAgICAgICAgICAgICAgICAgICAgZm9vdGVyOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgIHRleHQ6IGBQYWdlICR7cGFnZX0vJHttYXhQYWdlc31gXG4gICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgfSlcblxuICAgICAgICAgICAgaWYgKHBhZ2UgPiBtYXhQYWdlcyAmJiBwYWdlID4gMSlcbiAgICAgICAgICAgICAgICByZXR1cm4gYXdhaXQgbWVzc2FnZS5jaGFubmVsLnNlbmQoXCLinYwgV1RGPz8/INCd0LXRgiDRgyDQvNC10L3RjyDRgtCw0LrQvtC5INGB0YLRgNCw0L3QuNGG0YshXCIpXG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGZvciAoY29uc3QgdXNlciBvZiB1c2Vycykge1xuICAgICAgICAgICAgICAgIGNvbnN0IHRvdGFsVGltZSA9IEdldFRvdGFsVGltZSh1c2VyLmpvaW5zKSxcbiAgICAgICAgICAgICAgICBtZW1iZXIgPSBtZXNzYWdlLmd1aWxkLm1lbWJlcnMucmVzb2x2ZSh1c2VyLnVzZXJJRCksXG4gICAgICAgICAgICAgICAgaG91cnMgPSBNYXRoLmZsb29yKHRvdGFsVGltZSAvIDM2MDAgJSAyNCksXG4gICAgICAgICAgICAgICAgbWludXRlcyA9IE1hdGguZmxvb3IodG90YWxUaW1lIC8gNjAgJSA2MClcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBmaWVsZHMucHVzaCh7XG4gICAgICAgICAgICAgICAgICAgIG5hbWU6IGAke21lbWJlci51c2VyLnRhZ30gIOKMmiAke2hvdXJzIDwgMTAgPyBcIjBcIjogXCJcIn0ke2hvdXJzfToke21pbnV0ZXMgPCAxMCA/IFwiMFwiOiBcIlwifSR7TWF0aC5mbG9vcihtaW51dGVzKX1gLFxuICAgICAgICAgICAgICAgICAgICB2YWx1ZTogdXNlci5qb2lucy5tYXAoKGpvaW4sIGluZGV4KSA9PiBgSm9pbiAqKiMke2luZGV4KzF9KiogJHtzdHJmdGltZShcIiVSXCIsIGpvaW4uam9pbmVkQXQpfSR7am9pbi5sZWF2ZWRBdCA/IGBcXG5MZWZ0ICoqIyR7aW5kZXgrMX0qKiAke3N0cmZ0aW1lKFwiJVJcIiwgam9pbi5sZWF2ZWRBdCl9YCA6IFwiXCJ9YClcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIC8vIGVtYmVkLmFkZEZpZWxkcyhmaWVsZHMuc2xpY2UoKHBhZ2UtMSkgKiAxMCwgcGFnZSAqIDEwKSlcbiAgICAgICAgICAgIGVtYmVkLmFkZEZpZWxkcyhmaWVsZHMuc2xpY2UoKHBhZ2UtMSksIHBhZ2UpKVxuXG4gICAgICAgICAgICBpZiAoIWZpZWxkcy5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICBlbWJlZC5zZXREZXNjcmlwdGlvbihcItCX0LAg0Y3RgtGDINGB0LXRgdGB0LjRjiDQv9C+0LvRjNC30L7QstCw0YLQtdC70LXQuSDQvdC1INC30LDRhNC40LrRgdC40YDQvtCy0LDQvdC+XCIpXG4gICAgICAgICAgICAgICAgcmV0dXJuIG1lc3NhZ2UuY2hhbm5lbC5zZW5kKGVtYmVkKVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgXG4gICAgICAgICAgICBjb25zdCBtc2c6IE1lc3NhZ2UgPSBwcmV2TXNnIHx8IGF3YWl0IG1lc3NhZ2UuY2hhbm5lbC5zZW5kKGVtYmVkKVxuXG4gICAgICAgICAgICBpZiAocHJldk1zZylcbiAgICAgICAgICAgICAgICBhd2FpdCBwcmV2TXNnLmVkaXQoZW1iZWQpXG5cbiAgICAgICAgICAgIGlmIChtYXhQYWdlcyA9PSAxKVxuICAgICAgICAgICAgICAgIHJldHVyblxuXG4gICAgICAgICAgICBpZiAocGFnZSA+IDEpXG4gICAgICAgICAgICAgICAgYXdhaXQgbXNnLnJlYWN0KFwi4peA77iPXCIpXG5cbiAgICAgICAgICAgIGlmIChwYWdlIDwgbWF4UGFnZXMpXG4gICAgICAgICAgICAgICAgYXdhaXQgbXNnLnJlYWN0KFwi4pa277iPXCIpXG5cbiAgICAgICAgICAgIGNvbnN0IHJlYWN0aW9uID0gKGF3YWl0IG1zZy5hd2FpdFJlYWN0aW9ucygocmVhY3Rpb24sIHVzZXIpID0+ICgocGFnZSA+IDEgJiYgcmVhY3Rpb24uZW1vamkubmFtZSA9PSBcIuKXgO+4j1wiKSB8fCAocGFnZSA8IG1heFBhZ2VzICYmIHJlYWN0aW9uLmVtb2ppLm5hbWUgPT0gXCLilrbvuI9cIikpICYmIHVzZXIuaWQgPT0gbWVzc2FnZS5hdXRob3IuaWQsIHsgaWRsZTogM2U0LCBtYXg6IDEgfSkpLmZpcnN0KClcblxuICAgICAgICAgICAgaWYgKCFyZWFjdGlvbikge1xuICAgICAgICAgICAgICAgIGF3YWl0IG1zZy5lZGl0KGVtYmVkLnNldERlc2NyaXB0aW9uKFwiOng6INCf0YDQvtGI0LvQviAzMCDRgdC10LrRg9C90LQsINC90L4g0L3QuNC60LDQutC+0Lkg0YDQtdCw0LrRhtC40Lgg0L3QtSDQsdGL0LvQviDQvdCw0LnQtNC10L3Qvi5cXG5QLiBzLiDQntGC0L/RgNCw0LLRjCDQutC+0LzQsNC90LTRgyDQtdGJ0ZEg0YDQsNC3INGH0YLQvtCx0Ysg0LLQvtC30L7QsdC90L7QstC40YLRjCDRgdC60YDQvtC70LsuXCIpKVxuICAgICAgICAgICAgICAgIGF3YWl0IG1zZy5yZWFjdGlvbnMucmVtb3ZlQWxsKClcbiAgICAgICAgICAgICAgICByZXR1cm5cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGF3YWl0IG1zZy5yZWFjdGlvbnMucmVtb3ZlQWxsKClcblxuICAgICAgICAgICAgYXdhaXQgdGhpcy5leGVjKG1lc3NhZ2UsIFtzZWxlY3RlZERhdGVPclVzZXIsIHNlbGVjdGVkTW9kZV0sXG4gICAgICAgICAgICAgICAgcmVhY3Rpb24uZW1vamkubmFtZSA9PSBcIuKXgO+4j1wiID8gKHBhZ2UtMSkgOiByZWFjdGlvbi5lbW9qaS5uYW1lID09IFwi4pa277iPXCIgPyAocGFnZSsxKSA6IHBhZ2UsXG4gICAgICAgICAgICAgICAgbXNnXG4gICAgICAgICAgICApXG4gICAgICAgICAgICByZXR1cm5cbiAgICAgICAgfVxuICAgICAgICBjb25zdCB1c2VySURzID0gc2VsZWN0ZWREYXRlT3JVc2VyLm1hdGNoKC9bMC05XXsxOH0vZyksXG4gICAgICAgICAgICAgIHVzZXJJRCA9IHVzZXJJRHMgaW5zdGFuY2VvZiBBcnJheSA/IHVzZXJJRHNbMF0gOiBudWxsXG5cbiAgICAgICAgaWYgKCF1c2VySUQpXG4gICAgICAgICAgICByZXR1cm4gYXdhaXQgbWVzc2FnZS5jaGFubmVsLnNlbmQoXCLQndC10LrQvtGA0YDQtdC60YLQvdGL0Lkg0L/QvtC70YzQt9C+0LLQsNGC0LXQu9GMINC40LvQuCDQtNCw0YLQsC5cXG5QLiBTLiDQp9GC0L7QsdGLINGD0LrQsNC30LDRgtGMINC/0L7Qu9GM0LfQvtCy0LDRgtC10LvRjyDQuNGB0L/QvtC70YzQt9GD0LnRgtC1INGD0L/QvtC80LjQvdCw0L3QuNC1INC40LvQuCBJRC5cIilcblxuICAgICAgICBpZiAoIW1vZGVzLmluY2x1ZGVzKHNlbGVjdGVkTW9kZSkpXG4gICAgICAgICAgICByZXR1cm4gYXdhaXQgbWVzc2FnZS5jaGFubmVsLnNlbmQoYNCg0LXQttC40LzQsCBcXGAke3NlbGVjdGVkTW9kZSB8fCBcItCd0LUg0YPQutCw0LfQsNC9XCJ9XFxgINC90LUg0YHRg9GJ0LXRgdGC0LLRg9C10YIg0LIg0YLQtdC60YPRidC10Lwg0LrQvtC90YTQuNCz0LUuXFxuYCArIFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGDQlNC+0YHRgtGD0L/QvdGL0LUg0YDQtdC20LjQvNGLOiBcXGAke21vZGVzLmpvaW4oJ2AsIGAnKX1cXGBgKVxuXG4gICAgICAgIGNvbnN0IHVzZXJEb2MgPSBhd2FpdCBVc2VyLmZpbmRPbmUoe3VzZXJJRDogdXNlcklELCBsb2dNb2RlOiBzZWxlY3RlZE1vZGV9KS5leGVjKCksXG4gICAgICAgICAgICAgIG1lbWJlciA9IG1lc3NhZ2UuZ3VpbGQubWVtYmVycy5yZXNvbHZlKHVzZXJJRClcbiAgICAgICAgXG4gICAgICAgIGNvbnN0IGVtYmVkID0gbmV3IE1lc3NhZ2VFbWJlZCgpXG4gICAgICAgICAgICAgICAgLnNldENvbG9yKDB4MmYzMTM2KVxuICAgICAgICAgICAgICAgIC5zZXRUaXRsZShg0KHRgtCw0YLQuNGB0YLQuNC60LAg0L/QvtC70YzQt9C+0LLQsNGC0LXQu9GPICR7bWVtYmVyLnVzZXIudGFnfWApXG4gICAgICAgICAgICAgICAgLnNldFRodW1ibmFpbChtZW1iZXIudXNlci5kaXNwbGF5QXZhdGFyVVJMKCkpXG4gICAgICAgICAgICAgICAgLnNldERlc2NyaXB0aW9uKHVzZXJEb2MgPyB1c2VyRG9jLm5vdGUgOiBg0JTQsNC90L3Ri9C5INC/0L7Qu9GM0LfQvtCy0LDRgtC10LvRjCDQvtGC0YHRg9GC0YHRgtCy0YPQtdGCINCyINCx0LDQt9C1INC00LDQvdC90YvRhSDQsiDRgNC10LbQuNC80LUgXFxgJHtzZWxlY3RlZE1vZGV9XFxgLmApXG4gICAgICAgIGlmICh1c2VyRG9jKVxuICAgICAgICAgICAgICAgIGVtYmVkLmFkZEZpZWxkcyhBcnJheS5mcm9tKEdldFNvcnRlZFVzZXJKb2lucyh1c2VyRG9jKSkubWFwKChbZGF0ZSwgam9pbnNdKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHRvdGFsVGltZSA9IEdldFRvdGFsVGltZShqb2lucyksXG4gICAgICAgICAgICAgICAgICAgICAgICAgIGhvdXJzID0gTWF0aC5mbG9vcih0b3RhbFRpbWUgLyAzNjAwICUgMjQpLFxuICAgICAgICAgICAgICAgICAgICAgICAgICBtaW51dGVzID0gTWF0aC5mbG9vcih0b3RhbFRpbWUgLyA2MCAlIDYwKVxuICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiBgJHtzdHJmdGltZShcIiVkLiVtLiV5XCIsIG5ldyBEYXRlKGRhdGUpKX0gIOKMmiAke2hvdXJzIDwgMTAgPyBcIjBcIjogXCJcIn0ke2hvdXJzfToke21pbnV0ZXMgPCAxMCA/IFwiMFwiOiBcIlwifSR7TWF0aC5mbG9vcihtaW51dGVzKX1gLFxuICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGpvaW5zLm1hcChcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAoam9pbiwgaW5kZXgpID0+IGAqKiMke2luZGV4KzF9KiogJHtzdHJmdGltZShcIiVSXCIsIGpvaW4uam9pbmVkQXQpfSR7am9pbi5sZWF2ZWRBdCA/IGAgLSAke3N0cmZ0aW1lKFwiJVJcIiwgam9pbi5sZWF2ZWRBdCl9YCA6IFwiXCJ9YClcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pKVxuICAgICAgICBcbiAgICAgICAgYXdhaXQgbWVzc2FnZS5jaGFubmVsLnNlbmQoZW1iZWQpXG4gICAgfVxufSJdfQ==