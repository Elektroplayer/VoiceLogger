"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.GetSortedUserJoins = exports.GetDate = exports.GetTotalTime = exports.GetUsersForDateAndMode = exports.GetDateWithoutTime = exports.isDate = exports.DisableLog = exports.UserLeave = exports.UserJoin = exports.AddOrGetUser = exports.loadCommands = exports.loadListeners = void 0;
const fs_1 = __importDefault(require("fs"));
const path_1 = require("path");
const command_1 = __importDefault(require("./command"));
const listener_1 = __importDefault(require("./listener"));
const user_1 = __importDefault(require("../models/user"));
const discord_js_1 = require("discord.js");
const strftime_1 = __importDefault(require("strftime"));
function loadListeners(client, listenersDir) {
    for (const file of fs_1.default.readdirSync(listenersDir, { withFileTypes: true })) {
        if (file.isFile()) {
            try {
                const listenerClass = require(path_1.join(listenersDir, file.name)).default;
                if (!listener_1.default.isPrototypeOf(listenerClass))
                    return;
                const listener = new listenerClass(client);
                client.addListener(listener.type, listener.exec.bind(listener));
                console.log(`+ ${file.name}`);
            }
            catch (e) {
                console.log(`Cannot load ${file.name}\nError: ${e.stack}`);
            }
        }
    }
}
exports.loadListeners = loadListeners;
function loadCommands(client, commandsDir) {
    for (const file of fs_1.default.readdirSync(commandsDir, { withFileTypes: true })) {
        if (file.isFile()) {
            try {
                const commandClass = require(path_1.join(commandsDir, file.name)).default;
                if (!command_1.default.isPrototypeOf(commandClass))
                    return;
                const command = new commandClass(client);
                client.commands.push(command);
                console.log(`+ ${file.name}`);
            }
            catch (e) {
                console.log(`Cannot load ${file.name}\nError: ${e.stack}`);
            }
        }
    }
}
exports.loadCommands = loadCommands;
async function AddOrGetUser(user, mode) {
    const id = (user instanceof discord_js_1.User || user instanceof discord_js_1.GuildMember) ? user.id : user;
    var userDoc = await user_1.default.findOne({ userID: id, logMode: mode }).exec();
    if (userDoc)
        return userDoc;
    userDoc = new user_1.default();
    userDoc.userID = id;
    userDoc.note = "Заметка отсутствует";
    userDoc.logMode = mode;
    userDoc.joins = [];
    return await userDoc.save();
}
exports.AddOrGetUser = AddOrGetUser;
async function UserJoin(user, channel, logEnabledAt, mode) {
    const userID = user instanceof discord_js_1.User || user instanceof discord_js_1.GuildMember ? user.id : user;
    const channelID = channel instanceof discord_js_1.VoiceChannel ? channel.id : channel;
    const userDoc = await AddOrGetUser(userID, mode);
    const join = userDoc.joins.find(join => !join.logDisabledAt && !join.leavedAt);
    if (join)
        return join;
    userDoc.joins.push({
        channelID: channelID,
        logEnabledAt: logEnabledAt,
        logDisabledAt: null,
        joinedAt: new Date(),
        leavedAt: null
    });
    await user_1.default.updateOne({ userID: userID }, { $set: { joins: userDoc.joins } }).exec();
}
exports.UserJoin = UserJoin;
async function UserLeave(user, channel, mode) {
    const userID = user instanceof discord_js_1.User || user instanceof discord_js_1.GuildMember ? user.id : user, userDoc = await AddOrGetUser(userID, mode), channelID = channel instanceof discord_js_1.VoiceChannel ? channel.id : channel, index = userDoc.joins.findIndex(join => !join.logDisabledAt && !join.leavedAt && join.channelID == channelID), join = userDoc.joins[index];
    if (!userDoc.joins.length || !join)
        return;
    userDoc.joins[index] = {
        logEnabledAt: join.logEnabledAt,
        logDisabledAt: null,
        joinedAt: join.joinedAt,
        leavedAt: new Date(),
        channelID: join.channelID
    };
    await user_1.default.updateOne({ userID }, { $set: { joins: userDoc.joins } }).exec();
}
exports.UserLeave = UserLeave;
async function DisableLog() {
    const users = await user_1.default.find().exec();
    for (const user of users) {
        for (const { channelID, logDisabledAt } of user.joins) {
            if (logDisabledAt)
                continue;
            const index = user.joins.findIndex(join => join.channelID == channelID && !join.logDisabledAt);
            const join = user.joins[index];
            join.logDisabledAt = new Date();
            join.leavedAt = join.leavedAt || new Date();
            user.joins[index] = join;
        }
        await user_1.default.updateOne({ userID: user.userID }, { $set: { joins: user.joins } });
    }
}
exports.DisableLog = DisableLog;
function isDate(date) {
    return !isNaN(GetDate(date).valueOf());
}
exports.isDate = isDate;
function GetDateWithoutTime(date) {
    return strftime_1.default("%D", date);
}
exports.GetDateWithoutTime = GetDateWithoutTime;
async function GetUsersForDateAndMode(date, mode) {
    const usersDocs = await user_1.default.find().exec(), finalUsers = [];
    for (const userDoc of usersDocs) {
        if (!mode || userDoc.logMode != mode)
            continue;
        const finalJoins = [];
        for (const join of userDoc.joins)
            if (GetDateWithoutTime(join.logEnabledAt) == GetDateWithoutTime(date))
                finalJoins.push(join);
        if (!finalJoins.length)
            continue;
        userDoc.joins = finalJoins;
        finalUsers.push(userDoc);
    }
    return finalUsers;
}
exports.GetUsersForDateAndMode = GetUsersForDateAndMode;
function GetTotalTime(joins) {
    var time = 0;
    for (const join of joins) {
        if (!join.leavedAt)
            continue;
        time += join.leavedAt.valueOf() - join.joinedAt.valueOf();
    }
    return (time - time % 1000) / 1000;
}
exports.GetTotalTime = GetTotalTime;
function GetDate(date) {
    const dateArr = date.split(/\./g).reverse();
    if (dateArr.length == 3 && !dateArr[0].startsWith("20"))
        dateArr[0] = "20" + dateArr[0];
    return dateArr.length == 2 ? new Date(dateArr.join('.') + "." + new Date().getFullYear()) : new Date(dateArr.join('.'));
}
exports.GetDate = GetDate;
function GetSortedUserJoins(userDoc) {
    const map = new Map();
    for (const join of userDoc.joins) {
        const prevJoins = map.get(strftime_1.default("%D", join.joinedAt)), writeJoin = { joinedAt: join.joinedAt, leavedAt: join.leavedAt, channelID: join.channelID };
        map.set(strftime_1.default("%D", join.joinedAt), prevJoins ? [writeJoin, ...prevJoins] : [writeJoin]);
    }
    return map;
}
exports.GetSortedUserJoins = GetSortedUserJoins;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXRpbHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvbGliL3V0aWxzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLDRDQUE2QjtBQUM3QiwrQkFBK0I7QUFFL0Isd0RBQW9DO0FBQ3BDLDBEQUFxQztBQUNyQywwREFBeUM7QUFDekMsMkNBQXVFO0FBQ3ZFLHdEQUErQjtBQVEvQixTQUFnQixhQUFhLENBQUMsTUFBYyxFQUFFLFlBQW9CO0lBQzlELEtBQUssTUFBTSxJQUFJLElBQUksWUFBRSxDQUFDLFdBQVcsQ0FBQyxZQUFZLEVBQUUsRUFBQyxhQUFhLEVBQUUsSUFBSSxFQUFDLENBQUMsRUFBRTtRQUNwRSxJQUFJLElBQUksQ0FBQyxNQUFNLEVBQUUsRUFBRTtZQUNmLElBQUk7Z0JBQ0EsTUFBTSxhQUFhLEdBQUcsT0FBTyxDQUFDLFdBQUksQ0FBQyxZQUFZLEVBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFBO2dCQUVwRSxJQUFJLENBQUMsa0JBQVEsQ0FBQyxhQUFhLENBQUMsYUFBYSxDQUFDO29CQUN0QyxPQUFNO2dCQUVWLE1BQU0sUUFBUSxHQUFHLElBQUksYUFBYSxDQUFDLE1BQU0sQ0FBQyxDQUFBO2dCQUUxQyxNQUFNLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxJQUFJLEVBQUUsUUFBUSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQTtnQkFDL0QsT0FBTyxDQUFDLEdBQUcsQ0FBQyxLQUFLLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFBO2FBQ2hDO1lBQUMsT0FBTSxDQUFDLEVBQUU7Z0JBQ1AsT0FBTyxDQUFDLEdBQUcsQ0FBQyxlQUFlLElBQUksQ0FBQyxJQUFJLFlBQVksQ0FBQyxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUE7YUFDN0Q7U0FDSjtLQUNKO0FBQ0wsQ0FBQztBQWxCRCxzQ0FrQkM7QUFRRCxTQUFnQixZQUFZ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QUMsSUFBSSxFQUFFLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxFQUNsRCxTQUFTLEdBQUcsRUFBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLFFBQVEsRUFBRSxRQUFRLEVBQUUsSUFBSSxDQUFDLFFBQVEsRUFBRSxTQUFTLEVBQUUsSUFBSSxDQUFDLFNBQVMsRUFBQyxDQUFBO1FBRS9GLEdBQUcsQ0FBQyxHQUFHLENBQUMsa0JBQVEsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLFFBQVEsQ0FBQyxFQUFFLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxTQUFTLEVBQUUsR0FBRyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFBO0tBQzlGO0lBRUQsT0FBTyxHQUFHLENBQUE7QUFDZCxDQUFDO0FBWEQsZ0RBV0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgZnMgICAgICAgICAgIGZyb20gJ2ZzJ1xuaW1wb3J0IHsgam9pbiB9ICAgICBmcm9tICdwYXRoJ1xuaW1wb3J0IENsaWVudCAgICAgICBmcm9tICcuL2NsaWVudCdcbmltcG9ydCBDb21tYW5kICAgICAgZnJvbSAnLi9jb21tYW5kJ1xuaW1wb3J0IExpc3RlbmVyICAgICBmcm9tICcuL2xpc3RlbmVyJ1xuaW1wb3J0IFVzZXJNb2RlbCAgICBmcm9tICcuLi9tb2RlbHMvdXNlcidcbmltcG9ydCB7IEd1aWxkTWVtYmVyLCBTbm93Zmxha2UsIFVzZXIsIFZvaWNlQ2hhbm5lbCB9IGZyb20gJ2Rpc2NvcmQuanMnXG5pbXBvcnQgc3RyZnRpbWUgZnJvbSAnc3RyZnRpbWUnXG5cbi8qKlxuICogQSBmdW5jdGlvbiB3aGljaCBhZGRcbiAqIGFsbCBmaWxlcyB3aXRoIGV2ZW50IGxpc3RlbmVycyBpbiBwcm92aWRlZCBkaXIuXG4gKiBAcGFyYW0ge0NsaWVudH0gY2xpZW50IFxuICogQHBhcmFtIHtzdHJpbmd9IGxpc3RlbmVyc0RpciBcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGxvYWRMaXN0ZW5lcnMoY2xpZW50OiBDbGllbnQsIGxpc3RlbmVyc0Rpcjogc3RyaW5nKSB7XG4gICAgZm9yIChjb25zdCBmaWxlIG9mIGZzLnJlYWRkaXJTeW5jKGxpc3RlbmVyc0Rpciwge3dpdGhGaWxlVHlwZXM6IHRydWV9KSkge1xuICAgICAgICBpZiAoZmlsZS5pc0ZpbGUoKSkge1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICBjb25zdCBsaXN0ZW5lckNsYXNzID0gcmVxdWlyZShqb2luKGxpc3RlbmVyc0RpciwgZmlsZS5uYW1lKSkuZGVmYXVsdFxuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIGlmICghTGlzdGVuZXIuaXNQcm90b3R5cGVPZihsaXN0ZW5lckNsYXNzKSkgLy8g0J/RgNC+0LLQtdGA0Y/QtdC8INC90LDRgdC70LXQtNGD0LXRgiDQu9C4INC/0L7Qu9GD0YfQtdC90L3Ri9C5INC90LDQvNC4INC60LvQsNGB0YEg0LrQu9Cw0YHRgSDRgdC+0LHRi9GC0LjRjy5cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuXG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgY29uc3QgbGlzdGVuZXIgPSBuZXcgbGlzdGVuZXJDbGFzcyhjbGllbnQpXG5cbiAgICAgICAgICAgICAgICBjbGllbnQuYWRkTGlzdGVuZXIobGlzdGVuZXIudHlwZSwgbGlzdGVuZXIuZXhlYy5iaW5kKGxpc3RlbmVyKSlcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgKyAke2ZpbGUubmFtZX1gKVxuICAgICAgICAgICAgfSBjYXRjaChlKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coYENhbm5vdCBsb2FkICR7ZmlsZS5uYW1lfVxcbkVycm9yOiAke2Uuc3RhY2t9YClcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbn1cblxuLyoqXG4gKiBBIGZ1bmN0aW9uIHdoaWNoIGFkZFxuICogYWxsIGZpbGVzIHdpdGggZXZlbnQgbGlzdGVuZXJzIGluIHByb3ZpZGVkIGRpci5cbiAqIEBwYXJhbSB7Q2xpZW50fSBjbGllbnQgXG4gKiBAcGFyYW0ge3N0cmluZ30gY29tbWFuZHNEaXIgXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBsb2FkQ29tbWFuZHMoY2xpZW50OiBDbGllbnQsIGNvbW1hbmRzRGlyOiBzdHJpbmcpIHtcbiAgICBmb3IgKGNvbnN0IGZpbGUgb2YgZnMucmVhZGRpclN5bmMoY29tbWFuZHNEaXIsIHt3aXRoRmlsZVR5cGVzOiB0cnVlfSkpIHtcbiAgICAgICAgaWYgKGZpbGUuaXNGaWxlKCkpIHtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgY29uc3QgY29tbWFuZENsYXNzID0gcmVxdWlyZShqb2luKGNvbW1hbmRzRGlyLCBmaWxlLm5hbWUpKS5kZWZhdWx0XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgaWYgKCFDb21tYW5kLmlzUHJvdG90eXBlT2YoY29tbWFuZENsYXNzKSkgLy8g0J/RgNC+0LLQtdGA0Y/QtdC8INC90LDRgdC70LXQtNGD0LXRgiDQu9C4INC/0L7Qu9GD0YfQtdC90L3Ri9C5INC90LDQvNC4INC60LvQsNGB0YEg0LrQu9Cw0YHRgSDRgdC+0LHRi9GC0LjRjy5cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuXG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgY29uc3QgY29tbWFuZCA9IG5ldyBjb21tYW5kQ2xhc3MoY2xpZW50KVxuXG4gICAgICAgICAgICAgICAgY2xpZW50LmNvbW1hbmRzLnB1c2goY29tbWFuZClcblxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGArICR7ZmlsZS5uYW1lfWApXG4gICAgICAgICAgICB9IGNhdGNoKGUpIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgQ2Fubm90IGxvYWQgJHtmaWxlLm5hbWV9XFxuRXJyb3I6ICR7ZS5zdGFja31gKVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gQWRkT3JHZXRVc2VyKHVzZXI6IFVzZXIgfCBHdWlsZE1lbWJlciB8IFNub3dmbGFrZSwgbW9kZTogc3RyaW5nKSB7XG4gICAgY29uc3QgaWQ6IFNub3dmbGFrZSA9ICh1c2VyIGluc3RhbmNlb2YgVXNlciB8fCB1c2VyIGluc3RhbmNlb2YgR3VpbGRNZW1iZXIpID8gdXNlci5pZCA6IHVzZXJcbiAgICB2YXIgdXNlckRvYyA9IGF3YWl0IFVzZXJNb2RlbC5maW5kT25lKHt1c2VySUQ6IGlkLCBsb2dNb2RlOiBtb2RlfSkuZXhlYygpXG5cbiAgICBpZiAodXNlckRvYykgcmV0dXJuIHVzZXJEb2NcblxuICAgIHVzZXJEb2MgPSBuZXcgVXNlck1vZGVsKClcbiAgICB1c2VyRG9jLnVzZXJJRCA9IGlkXG4gICAgdXNlckRvYy5ub3RlID0gXCLQl9Cw0LzQtdGC0LrQsCDQvtGC0YHRg9GC0YHRgtCy0YPQtdGCXCJcbiAgICB1c2VyRG9jLmxvZ01vZGUgPSBtb2RlXG4gICAgdXNlckRvYy5qb2lucyA9IFtdXG5cbiAgICByZXR1cm4gYXdhaXQgdXNlckRvYy5zYXZlKClcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIFVzZXJKb2luKHVzZXI6IFVzZXIgfCBHdWlsZE1lbWJlciB8IFNub3dmbGFrZSwgY2hhbm5lbDogVm9pY2VDaGFubmVsIHwgU25vd2ZsYWtlLCBsb2dFbmFibGVkQXQ6IERhdGUsIG1vZGU6IHN0cmluZykge1xuICAgIGNvbnN0IHVzZXJJRDogU25vd2ZsYWtlID0gdXNlciBpbnN0YW5jZW9mIFVzZXIgfHwgdXNlciBpbnN0YW5jZW9mIEd1aWxkTWVtYmVyID8gdXNlci5pZCA6IHVzZXJcbiAgICBjb25zdCBjaGFubmVsSUQgPSBjaGFubmVsIGluc3RhbmNlb2YgVm9pY2VDaGFubmVsID8gY2hhbm5lbC5pZCA6IGNoYW5uZWxcbiAgICBjb25zdCB1c2VyRG9jID0gYXdhaXQgQWRkT3JHZXRVc2VyKHVzZXJJRCwgbW9kZSlcblxuICAgIGNvbnN0IGpvaW4gPSB1c2VyRG9jLmpvaW5zLmZpbmQoam9pbiA9PiAham9pbi5sb2dEaXNhYmxlZEF0ICYmICFqb2luLmxlYXZlZEF0KVxuXG4gICAgaWYgKGpvaW4pIHJldHVybiBqb2luXG5cbiAgICB1c2VyRG9jLmpvaW5zLnB1c2goe1xuICAgICAgICBjaGFubmVsSUQ6IGNoYW5uZWxJRCxcbiAgICAgICAgbG9nRW5hYmxlZEF0OiBsb2dFbmFibGVkQXQsXG4gICAgICAgIGxvZ0Rpc2FibGVkQXQ6IG51bGwsXG4gICAgICAgIGpvaW5lZEF0OiBuZXcgRGF0ZSgpLFxuICAgICAgICBsZWF2ZWRBdDogbnVsbFxuICAgIH0pXG5cbiAgICBhd2FpdCBVc2VyTW9kZWwudXBkYXRlT25lKHt1c2VySUQ6IHVzZXJJRH0sIHskc2V0OiB7am9pbnM6IHVzZXJEb2Muam9pbnN9fSkuZXhlYygpXG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBVc2VyTGVhdmUodXNlcjogVXNlciB8IEd1aWxkTWVtYmVyIHwgU25vd2ZsYWtlLCBjaGFubmVsOiBWb2ljZUNoYW5uZWwgfCBTbm93Zmxha2UsIG1vZGU6IHN0cmluZykge1xuICAgIGNvbnN0IHVzZXJJRDogU25vd2ZsYWtlID0gdXNlciBpbnN0YW5jZW9mIFVzZXIgfHwgdXNlciBpbnN0YW5jZW9mIEd1aWxkTWVtYmVyID8gdXNlci5pZCA6IHVzZXIsXG4gICAgICAgICAgdXNlckRvYyA9IGF3YWl0IEFkZE9yR2V0VXNlcih1c2VySUQsIG1vZGUpLFxuICAgICAgICAgIGNoYW5uZWxJRCA9IGNoYW5uZWwgaW5zdGFuY2VvZiBWb2ljZUNoYW5uZWwgPyBjaGFubmVsLmlkIDogY2hhbm5lbCxcbiAgICAgICAgICBpbmRleCA9IHVzZXJEb2Muam9pbnMuZmluZEluZGV4KGpvaW4gPT4gIWpvaW4ubG9nRGlzYWJsZWRBdCAmJiAham9pbi5sZWF2ZWRBdCAmJiBqb2luLmNoYW5uZWxJRCA9PSBjaGFubmVsSUQpLFxuICAgICAgICAgIGpvaW4gPSB1c2VyRG9jLmpvaW5zW2luZGV4XVxuXG4gICAgaWYgKCF1c2VyRG9jLmpvaW5zLmxlbmd0aCB8fCAham9pbikgcmV0dXJuXG5cbiAgICB1c2VyRG9jLmpvaW5zW2luZGV4XSA9IHtcbiAgICAgICAgbG9nRW5hYmxlZEF0OiBqb2luLmxvZ0VuYWJsZWRBdCxcbiAgICAgICAgbG9nRGlzYWJsZWRBdDogbnVsbCxcbiAgICAgICAgam9pbmVkQXQ6IGpvaW4uam9pbmVkQXQsXG4gICAgICAgIGxlYXZlZEF0OiBuZXcgRGF0ZSgpLFxuICAgICAgICBjaGFubmVsSUQ6IGpvaW4uY2hhbm5lbElEXG4gICAgfVxuXG4gICAgYXdhaXQgVXNlck1vZGVsLnVwZGF0ZU9uZSh7dXNlcklEfSwgeyRzZXQ6IHtqb2luczogdXNlckRvYy5qb2luc319KS5leGVjKClcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIERpc2FibGVMb2coKSB7XG4gICAgY29uc3QgdXNlcnMgPSBhd2FpdCBVc2VyTW9kZWwuZmluZCgpLmV4ZWMoKVxuICAgIGZvciAoY29uc3QgdXNlciBvZiB1c2Vycykge1xuICAgICAgICBmb3IgKGNvbnN0IHsgY2hhbm5lbElELCBsb2dEaXNhYmxlZEF0IH0gb2YgdXNlci5qb2lucykge1xuICAgICAgICAgICAgaWYgKGxvZ0Rpc2FibGVkQXQpIGNvbnRpbnVlXG4gICAgICAgICAgICBjb25zdCBpbmRleCA9IHVzZXIuam9pbnMuZmluZEluZGV4KGpvaW4gPT4gam9pbi5jaGFubmVsSUQgPT0gY2hhbm5lbElEICYmICFqb2luLmxvZ0Rpc2FibGVkQXQpXG4gICAgICAgICAgICBjb25zdCBqb2luID0gdXNlci5qb2luc1tpbmRleF1cbiAgICAgICAgICAgIGpvaW4ubG9nRGlzYWJsZWRBdCA9IG5ldyBEYXRlKClcbiAgICAgICAgICAgIGpvaW4ubGVhdmVkQXQgPSBqb2luLmxlYXZlZEF0IHx8IG5ldyBEYXRlKClcbiAgICAgICAgICAgIHVzZXIuam9pbnNbaW5kZXhdID0gam9pblxuICAgICAgICB9XG4gICAgICAgIGF3YWl0IFVzZXJNb2RlbC51cGRhdGVPbmUoe3VzZXJJRDogdXNlci51c2VySUR9LCB7JHNldDoge2pvaW5zOiB1c2VyLmpvaW5zfX0pXG4gICAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gaXNEYXRlKGRhdGUpOiBib29sZWFuIHtcbiAgICByZXR1cm4gIWlzTmFOKEdldERhdGUoZGF0ZSkudmFsdWVPZigpKVxufVxuXG5leHBvcnQgZnVuY3Rpb24gR2V0RGF0ZVdpdGhvdXRUaW1lKGRhdGU6IERhdGUpOiBzdHJpbmcge1xuICAgIHJldHVybiBzdHJmdGltZShcIiVEXCIsIGRhdGUpXG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBHZXRVc2Vyc0ZvckRhdGVBbmRNb2RlKGRhdGU6IERhdGUsIG1vZGU6IHN0cmluZykge1xuICAgIGNvbnN0IHVzZXJzRG9jcyA9IGF3YWl0IFVzZXJNb2RlbC5maW5kKCkuZXhlYygpLFxuICAgICAgICAgIGZpbmFsVXNlcnMgPSBbXVxuXG4gICAgZm9yIChjb25zdCB1c2VyRG9jIG9mIHVzZXJzRG9jcykge1xuICAgICAgICBpZiAoIW1vZGUgfHwgdXNlckRvYy5sb2dNb2RlICE9IG1vZGUpIGNvbnRpbnVlXG4gICAgICAgIGNvbnN0IGZpbmFsSm9pbnMgPSBbXVxuICAgICAgICBmb3IgKGNvbnN0IGpvaW4gb2YgdXNlckRvYy5qb2lucylcbiAgICAgICAgICAgIGlmIChHZXREYXRlV2l0aG91dFRpbWUoam9pbi5sb2dFbmFibGVkQXQpID09IEdldERhdGVXaXRob3V0VGltZShkYXRlKSkgZmluYWxKb2lucy5wdXNoKGpvaW4pXG5cbiAgICAgICAgaWYgKCFmaW5hbEpvaW5zLmxlbmd0aCkgY29udGludWVcblxuICAgICAgICB1c2VyRG9jLmpvaW5zID0gZmluYWxKb2luc1xuICAgICAgICBmaW5hbFVzZXJzLnB1c2godXNlckRvYylcbiAgICB9XG5cbiAgICByZXR1cm4gZmluYWxVc2Vyc1xufVxuXG5leHBvcnQgZnVuY3Rpb24gR2V0VG90YWxUaW1lKGpvaW5zKTogbnVtYmVyIHtcbiAgICB2YXIgdGltZSA9IDBcblxuICAgIGZvciAoY29uc3Qgam9pbiBvZiBqb2lucykge1xuICAgICAgICBpZiAoIWpvaW4ubGVhdmVkQXQpIGNvbnRpbnVlXG4gICAgICAgIHRpbWUgKz0gam9pbi5sZWF2ZWRBdC52YWx1ZU9mKCkgLSBqb2luLmpvaW5lZEF0LnZhbHVlT2YoKVxuICAgIH1cblxuICAgIHJldHVybiAodGltZSAtIHRpbWUgJSAxMDAwKSAvIDEwMDBcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIEdldERhdGUoZGF0ZTogc3RyaW5nKTogRGF0ZSB7XG4gICAgY29uc3QgZGF0ZUFyciA9IGRhdGUuc3BsaXQoL1xcLi9nKS5yZXZlcnNlKClcbiAgICBpZiAoZGF0ZUFyci5sZW5ndGggPT0gMyAmJiAhZGF0ZUFyclswXS5zdGFydHNXaXRoKFwiMjBcIikpXG4gICAgICAgIGRhdGVBcnJbMF0gPSBcIjIwXCIgKyBkYXRlQXJyWzBdXG4gICAgcmV0dXJuIGRhdGVBcnIubGVuZ3RoID09IDIgPyBuZXcgRGF0ZShkYXRlQXJyLmpvaW4oJy4nKSArIFwiLlwiICsgbmV3IERhdGUoKS5nZXRGdWxsWWVhcigpKSA6IG5ldyBEYXRlKGRhdGVBcnIuam9pbignLicpKVxufVxuXG5leHBvcnQgZnVuY3Rpb24gR2V0U29ydGVkVXNlckpvaW5zKHVzZXJEb2MpIHtcbiAgICBjb25zdCBtYXAgPSBuZXcgTWFwPHN0cmluZywgYW55W10+KClcblxuICAgIGZvciAoY29uc3Qgam9pbiBvZiB1c2VyRG9jLmpvaW5zKSB7XG4gICAgICAgIGNvbnN0IHByZXZKb2lucyA9IG1hcC5nZXQoc3RyZnRpbWUoXCIlRFwiLCBqb2luLmpvaW5lZEF0KSksXG4gICAgICAgICAgICAgIHdyaXRlSm9pbiA9IHtqb2luZWRBdDogam9pbi5qb2luZWRBdCwgbGVhdmVkQXQ6IGpvaW4ubGVhdmVkQXQsIGNoYW5uZWxJRDogam9pbi5jaGFubmVsSUR9XG4gICAgICAgIFxuICAgICAgICBtYXAuc2V0KHN0cmZ0aW1lKFwiJURcIiwgam9pbi5qb2luZWRBdCksIHByZXZKb2lucyA/IFt3cml0ZUpvaW4sIC4uLnByZXZKb2luc10gOiBbd3JpdGVKb2luXSlcbiAgICB9XG5cbiAgICByZXR1cm4gbWFwXG59Il19