"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.FindUser = exports.UserLeaved = exports.DisableLog = exports.AddChannel = exports.loadCommands = exports.loadListeners = void 0;
const listener_1 = __importDefault(require("./listener"));
const path_1 = require("path");
const fs_1 = __importDefault(require("fs"));
const command_1 = __importDefault(require("./command"));
const voice_log_1 = __importDefault(require("../models/voice-log"));
function loadListeners(client, listenersDir) {
    for (const file of fs_1.default.readdirSync(listenersDir, { withFileTypes: true })) {
        if (file.isFile()) {
            try {
                const listenerClass = require(path_1.join(listenersDir, file.name)).default;
                if (!listener_1.default.isPrototypeOf(listenerClass))
                    return;
                const listener = new listenerClass(client);
                client.addListener(listener.type, listener.exec.bind(listener));
                console.log(`+ ${file.name}`);
            }
            catch (e) {
                console.log(`Cannot load ${file.name}\nError: ${e.stack}`);
            }
        }
    }
}
exports.loadListeners = loadListeners;
function loadCommands(client, commandsDir) {
    for (const file of fs_1.default.readdirSync(commandsDir, { withFileTypes: true })) {
        if (file.isFile()) {
            try {
                const commandClass = require(path_1.join(commandsDir, file.name)).default;
                if (!command_1.default.isPrototypeOf(commandClass))
                    return;
                const command = new commandClass(client);
                for (const alias of command.aliases)
                    client.commands.set(alias.toLowerCase(), command);
                console.log(`+ ${file.name}`);
            }
            catch (e) {
                console.log(`Cannot load ${file.name}\nError: ${e.stack}`);
            }
        }
    }
}
exports.loadCommands = loadCommands;
async function AddChannel(voiceChannel, enabledAt) {
    const channel = await voice_log_1.default.findOne({ channelID: voiceChannel.id, logEnabledAt: enabledAt, logDisabledAt: null }).exec();
    if (channel)
        return channel;
    return (await voice_log_1.default.insertMany({
        channelID: voiceChannel.id,
        logEnabledAt: enabledAt,
        logDisabledAt: null,
        users: []
    }))[0];
}
exports.AddChannel = AddChannel;
async function DisableLog() {
    await voice_log_1.default.updateMany({ logDisabledAt: null }, { $set: { logDisabledAt: new Date() } }).exec();
}
exports.DisableLog = DisableLog;
function UserLeaved(user, channel) {
    const id = typeof user == "string" ? user : user.id;
    user = FindUser(id, channel.users);
    if (!user)
        return [];
    const index = channel.users.indexOf(user);
    channel.users[index].leavedAt = new Date();
    return channel.users;
}
exports.UserLeaved = UserLeaved;
function FindUser(user, array) {
    const id = typeof user == "string" ? user : user.id;
    for (const user of array)
        if (user.id == id && !user.leavedAt && !user.logDisabledAt)
            return user;
}
exports.FindUser = FindUser;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXRpbHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvbGliL3V0aWxzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUVBLDBEQUFxQztBQUVyQywrQkFBK0I7QUFDL0IsNENBQTZCO0FBQzdCLHdEQUErQjtBQUUvQixvRUFBMEM7QUFRMUMsU0FBZ0IsYUFBYSxDQUFDLE1BQWMsRUFBRSxZQUFvQjtJQUM5RCxLQUFLLE1BQU0sSUFBSSxJQUFJLFlBQUUsQ0FBQyxXQUFXLENBQUMsWUFBWSxFQUFFLEVBQUMsYUFBYSxFQUFFLElBQUksRUFBQyxDQUFDLEVBQUU7UUFDcEUsSUFBSSxJQUFJLENBQUMsTUFBTSxFQUFFLEVBQUU7WUFDZixJQUFJO2dCQUNBLE1BQU0sYUFBYSxHQUFHLE9BQU8sQ0FBQyxXQUFJLENBQUMsWUFBWSxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQTtnQkFFcEUsSUFBSSxDQUFDLGtCQUFRLENBQUMsYUFBYSxDQUFDLGFBQWEsQ0FBQztvQkFDdEMsT0FBTTtnQkFFVixNQUFNLFFBQVEsR0FBRyxJQUFJLGFBQWEsQ0FBQyxNQUFNLENBQUMsQ0FBQTtnQkFFMUMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMsSUFBSSxFQUFFLFFBQVEsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUE7Z0JBQy9ELE9BQU8sQ0FBQyxHQUFHLENBQUMsS0FBSyxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQTthQUNoQztZQUFDLE9BQU0sQ0FBQyxFQUFFO2dCQUNQLE9BQU8sQ0FBQyxHQUFHLENBQUMsZUFBZSxJQUFJLENBQUMsSUFBSSxZQUFZLENBQUMsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFBO2FBQzdEO1NBQ0o7S0FDSjtBQUNMLENBQUM7QUFsQkQsc0NBa0JDO0FBUUQsU0FBZ0IsWUFBWSxDQUFDLE1BQWMsRUFBRSxXQUFtQjtJQUM1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SUFBSSxDQUFDLEVBQUUsQ0FBQTtJQUNuRCxLQUFLLE1BQU0sSUFBSSxJQUFJLEtBQUs7UUFDcEIsSUFBSSxJQUFJLENBQUMsRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLElBQUksQ0FBQyxJQUFJLENBQUMsYUFBYTtZQUN0RCxPQUFPLElBQUksQ0FBQTtBQUN2QixDQUFDO0FBTEQsNEJBS0MiLCJzb3VyY2VzQ29udGVudCI6WyIvLy8gPHJlZmVyZW5jZSBwYXRoPVwidHlwaW5ncy5kLnRzXCIgLz5cblxuaW1wb3J0IExpc3RlbmVyICAgICBmcm9tICcuL2xpc3RlbmVyJ1xuaW1wb3J0IENsaWVudCAgICAgICBmcm9tICcuL2NsaWVudCdcbmltcG9ydCB7IGpvaW4gfSAgICAgZnJvbSAncGF0aCdcbmltcG9ydCBmcyAgICAgICAgICAgZnJvbSAnZnMnXG5pbXBvcnQgQ29tbWFuZCBmcm9tICcuL2NvbW1hbmQnXG5pbXBvcnQgeyBHdWlsZE1lbWJlciwgU25vd2ZsYWtlLCBVc2VyLCBWb2ljZUNoYW5uZWwgfSBmcm9tICdkaXNjb3JkLmpzJ1xuaW1wb3J0IFZvaWNlTG9nIGZyb20gJy4uL21vZGVscy92b2ljZS1sb2cnXG5cbi8qKlxuICogQSBmdW5jdGlvbiB3aGljaCBhZGRcbiAqIGFsbCBmaWxlcyB3aXRoIGV2ZW50IGxpc3RlbmVycyBpbiBwcm92aWRlZCBkaXIuXG4gKiBAcGFyYW0ge0NsaWVudH0gY2xpZW50IFxuICogQHBhcmFtIHtzdHJpbmd9IGxpc3RlbmVyc0RpciBcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGxvYWRMaXN0ZW5lcnMoY2xpZW50OiBDbGllbnQsIGxpc3RlbmVyc0Rpcjogc3RyaW5nKSB7XG4gICAgZm9yIChjb25zdCBmaWxlIG9mIGZzLnJlYWRkaXJTeW5jKGxpc3RlbmVyc0Rpciwge3dpdGhGaWxlVHlwZXM6IHRydWV9KSkge1xuICAgICAgICBpZiAoZmlsZS5pc0ZpbGUoKSkge1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICBjb25zdCBsaXN0ZW5lckNsYXNzID0gcmVxdWlyZShqb2luKGxpc3RlbmVyc0RpciwgZmlsZS5uYW1lKSkuZGVmYXVsdFxuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIGlmICghTGlzdGVuZXIuaXNQcm90b3R5cGVPZihsaXN0ZW5lckNsYXNzKSkgLy8g0J/RgNC+0LLQtdGA0Y/QtdC8INC90LDRgdC70LXQtNGD0LXRgiDQu9C4INC/0L7Qu9GD0YfQtdC90L3Ri9C5INC90LDQvNC4INC60LvQsNGB0YEg0LrQu9Cw0YHRgSDRgdC+0LHRi9GC0LjRjy5cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuXG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgY29uc3QgbGlzdGVuZXIgPSBuZXcgbGlzdGVuZXJDbGFzcyhjbGllbnQpXG5cbiAgICAgICAgICAgICAgICBjbGllbnQuYWRkTGlzdGVuZXIobGlzdGVuZXIudHlwZSwgbGlzdGVuZXIuZXhlYy5iaW5kKGxpc3RlbmVyKSlcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgKyAke2ZpbGUubmFtZX1gKVxuICAgICAgICAgICAgfSBjYXRjaChlKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coYENhbm5vdCBsb2FkICR7ZmlsZS5uYW1lfVxcbkVycm9yOiAke2Uuc3RhY2t9YClcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbn1cblxuLyoqXG4gKiBBIGZ1bmN0aW9uIHdoaWNoIGFkZFxuICogYWxsIGZpbGVzIHdpdGggZXZlbnQgbGlzdGVuZXJzIGluIHByb3ZpZGVkIGRpci5cbiAqIEBwYXJhbSB7Q2xpZW50fSBjbGllbnQgXG4gKiBAcGFyYW0ge3N0cmluZ30gY29tbWFuZHNEaXIgXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBsb2FkQ29tbWFuZHMoY2xpZW50OiBDbGllbnQsIGNvbW1hbmRzRGlyOiBzdHJpbmcpIHtcbiAgICBmb3IgKGNvbnN0IGZpbGUgb2YgZnMucmVhZGRpclN5bmMoY29tbWFuZHNEaXIsIHt3aXRoRmlsZVR5cGVzOiB0cnVlfSkpIHtcbiAgICAgICAgaWYgKGZpbGUuaXNGaWxlKCkpIHtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgY29uc3QgY29tbWFuZENsYXNzID0gcmVxdWlyZShqb2luKGNvbW1hbmRzRGlyLCBmaWxlLm5hbWUpKS5kZWZhdWx0XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgaWYgKCFDb21tYW5kLmlzUHJvdG90eXBlT2YoY29tbWFuZENsYXNzKSkgLy8g0J/RgNC+0LLQtdGA0Y/QtdC8INC90LDRgdC70LXQtNGD0LXRgiDQu9C4INC/0L7Qu9GD0YfQtdC90L3Ri9C5INC90LDQvNC4INC60LvQsNGB0YEg0LrQu9Cw0YHRgSDRgdC+0LHRi9GC0LjRjy5cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuXG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgY29uc3QgY29tbWFuZCA9IG5ldyBjb21tYW5kQ2xhc3MoY2xpZW50KVxuXG4gICAgICAgICAgICAgICAgZm9yIChjb25zdCBhbGlhcyBvZiBjb21tYW5kLmFsaWFzZXMpXG4gICAgICAgICAgICAgICAgICAgIGNsaWVudC5jb21tYW5kcy5zZXQoYWxpYXMudG9Mb3dlckNhc2UoKSwgY29tbWFuZClcblxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGArICR7ZmlsZS5uYW1lfWApXG4gICAgICAgICAgICB9IGNhdGNoKGUpIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgQ2Fubm90IGxvYWQgJHtmaWxlLm5hbWV9XFxuRXJyb3I6ICR7ZS5zdGFja31gKVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gQWRkQ2hhbm5lbCh2b2ljZUNoYW5uZWw6IFZvaWNlQ2hhbm5lbCwgZW5hYmxlZEF0OiBEYXRlKSB7XG4gICAgY29uc3QgY2hhbm5lbCA9IGF3YWl0IFZvaWNlTG9nLmZpbmRPbmUoe2NoYW5uZWxJRDogdm9pY2VDaGFubmVsLmlkLCBsb2dFbmFibGVkQXQ6IGVuYWJsZWRBdCwgbG9nRGlzYWJsZWRBdDogbnVsbH0pLmV4ZWMoKVxuXG4gICAgLy8g0J/RgNC+0YHRgtCw0Y8g0L/RgNC+0LLQtdGA0LrQsCwg0YfRgtC+0LHRiyDQsiDRgdC70YPRh9Cw0LUg0YfQtdCz0L4g0L3QtSDQvNGD0YHQvtGA0LjRgtGMINCyINCx0LQg0Lgg0L3QtSDQu9C+0LzQsNGC0Ywg0YDQsNCx0L7RgtGDINC70L7Qs9C40YDQvtCy0LDQvdC40Y9cbiAgICBpZiAoY2hhbm5lbCkgcmV0dXJuIGNoYW5uZWxcblxuICAgIHJldHVybiAoYXdhaXQgVm9pY2VMb2cuaW5zZXJ0TWFueSh7XG4gICAgICAgIGNoYW5uZWxJRDogdm9pY2VDaGFubmVsLmlkLFxuICAgICAgICBsb2dFbmFibGVkQXQ6IGVuYWJsZWRBdCxcbiAgICAgICAgbG9nRGlzYWJsZWRBdDogbnVsbCxcbiAgICAgICAgdXNlcnM6IFtdXG4gICAgfSkpWzBdXG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBEaXNhYmxlTG9nKCkge1xuICAgIGF3YWl0IFZvaWNlTG9nLnVwZGF0ZU1hbnkoe2xvZ0Rpc2FibGVkQXQ6IG51bGx9LCB7JHNldDoge2xvZ0Rpc2FibGVkQXQ6IG5ldyBEYXRlKCl9fSkuZXhlYygpXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBVc2VyTGVhdmVkKHVzZXI6IFVzZXIgfCBHdWlsZE1lbWJlciB8IFNub3dmbGFrZSwgY2hhbm5lbCkge1xuICAgIGNvbnN0IGlkID0gdHlwZW9mIHVzZXIgPT0gXCJzdHJpbmdcIiA/IHVzZXIgOiB1c2VyLmlkXG4gICAgdXNlciA9IEZpbmRVc2VyKGlkLCBjaGFubmVsLnVzZXJzKVxuICAgIC8vINCV0YHQu9C4INC+0L0g0LrQsNC60LjQvC3RgtC+INC80LjRgdGC0LjRh9C10YHQutC40Lwg0L7QsdGA0LDQt9C+0Lwg0LfQsNGI0ZHQuyDQsiDQutCw0L3QsNC7INC4INC90LUg0L/QvtC/0LDQuyDQv9C+0LQg0LvQvtCz0LXRgCAo0L3QsNC/0YDQuNC80LXRgCDQsdC+0YIg0LHRi9C7INCyINC+0YTRhNC1INC40LvQuCDRgdCw0Lwg0LvQvtCz0LPQtdGAINCx0YvQuyDQvtGC0LrQu9GO0YfQtdC9KSwg0YLQviDQvNGLINC10LPQviDQv9GA0L7Qv9GD0YHQutCw0LXQvCDQstC+INC40LfQsdC10LbQsNC90LjQtSDQvtGI0LjQsdC+0LpcbiAgICBpZiAoIXVzZXIpIHJldHVybiBbXVxuXG4gICAgY29uc3QgaW5kZXggPSBjaGFubmVsLnVzZXJzLmluZGV4T2YodXNlcilcbiAgICBjaGFubmVsLnVzZXJzW2luZGV4XS5sZWF2ZWRBdCA9IG5ldyBEYXRlKClcbiAgICByZXR1cm4gY2hhbm5lbC51c2Vyc1xufVxuXG5leHBvcnQgZnVuY3Rpb24gRmluZFVzZXIodXNlcjogVXNlciB8IEd1aWxkTWVtYmVyIHwgU25vd2ZsYWtlLCBhcnJheTogYW55W10pIHtcbiAgICBjb25zdCBpZCA9IHR5cGVvZiB1c2VyID09IFwic3RyaW5nXCIgPyB1c2VyIDogdXNlci5pZFxuICAgIGZvciAoY29uc3QgdXNlciBvZiBhcnJheSkgXG4gICAgICAgIGlmICh1c2VyLmlkID09IGlkICYmICF1c2VyLmxlYXZlZEF0ICYmICF1c2VyLmxvZ0Rpc2FibGVkQXQpXG4gICAgICAgICAgICByZXR1cm4gdXNlclxufSJdfQ==